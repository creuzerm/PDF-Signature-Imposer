<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Booklet Signature Imposer</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- pdf-lib: A library for creating and modifying PDF documents -->
    <script src="https://cdn.jsdelivr.net/npm/pdf-lib/dist/pdf-lib.min.js"></script>
    <!-- Core Imposition Logic (Shared) -->
    <script src="src/imposition_logic.js"></script>
    <script src="src/layout_logic.js"></script>
    <style>
        /* Custom styles for a better look and feel */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .file-input-label {
            transition: background-color 0.2s, border-color 0.2s;
        }
        #process-btn {
            transition: background-color 0.2s, transform 0.2s;
        }
        #process-btn:hover {
            transform: translateY(-2px);
        }
        #process-btn:disabled {
            cursor: not-allowed;
            opacity: 0.5;
            transform: none;
        }
        .spinner {
            border-top-color: transparent;
            width: 1rem;
            height: 1rem;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200 min-h-screen flex items-center justify-center p-4">

    <main class="w-full max-w-2xl bg-white dark:bg-gray-800 rounded-2xl shadow-2xl p-6 md:p-10 space-y-8">
        <!-- Header Section -->
        <header class="text-center">
            <h1 class="text-3xl md:text-4xl font-bold text-indigo-600 dark:text-indigo-400">PDF Signature Imposer</h1>
            <p class="mt-2 text-gray-600 dark:text-gray-400">Reorder PDF pages for multi-signature booklet printing.</p>
        </header>

        <!-- Main Controls Section -->
        <div class="space-y-6">
            <!-- Step 1: Upload PDF -->
            <div>
                <label for="pdf-upload" class="block text-lg font-semibold mb-2">1. Upload PDF</label>
                <label for="pdf-upload" class="file-input-label flex items-center justify-center w-full h-32 px-4 text-center bg-gray-50 dark:bg-gray-700 border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-600">
                    <span id="file-name-display" class="text-gray-500 dark:text-gray-400">Click to browse or drag & drop</span>
                </label>
                <input type="file" id="pdf-upload" class="hidden" accept=".pdf">
            </div>

            <!-- Step 2: Signature Size -->
            <div>
                <label for="signature-size" class="block text-lg font-semibold mb-2">2. Pages per Signature</label>
                <select id="signature-size" class="w-full p-3 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                    <option value="4">4 pages (1 sheet)</option>
                    <option value="8">8 pages (2 sheets)</option>
                    <option value="12">12 pages (3 sheets)</option>
                    <option value="16" selected>16 pages (4 sheets)</option>
                    <option value="20">20 pages (5 sheets)</option>
                    <option value="24">24 pages (6 sheets)</option>
                    <option value="28">28 pages (7 sheets)</option>
                    <option value="32">32 pages (8 sheets)</option>
                </select>
                <p class="text-xs text-gray-500 mt-1">Must be a multiple of 4. Efficiency is auto-selected for 16-32 pages.</p>
            </div>

            <!-- Step 3: Separate Cover with Flyleaf -->
            <div class="flex items-center mt-4">
                <input id="separate-cover-flyleaf" type="checkbox" class="h-5 w-5 text-indigo-600 border-gray-300 dark:border-gray-600 rounded focus:ring-indigo-500 bg-gray-50 dark:bg-gray-700">
                <label for="separate-cover-flyleaf" class="ml-3 block text-sm font-medium text-gray-700 dark:text-gray-300">
                    Separate cover with flyleaf
                </label>
            </div>

            <!-- Step 4: 2-up Imposition -->
            <div class="flex items-center mt-2">
                <input id="create-2up" type="checkbox" checked class="h-5 w-5 text-indigo-600 border-gray-300 dark:border-gray-600 rounded focus:ring-indigo-500 bg-gray-50 dark:bg-gray-700">
                <label for="create-2up" class="ml-3 block text-sm font-medium text-gray-700 dark:text-gray-300">
                    Create 2-up Spreads (for duplex printing)
                </label>
            </div>

            <!-- Action Button -->
            <div class="pt-4">
                <button id="process-btn" class="w-full flex items-center justify-center bg-indigo-600 text-white font-bold text-lg py-4 rounded-lg shadow-lg hover:bg-indigo-700 disabled:bg-indigo-400">
                    <span id="btn-text">Repaginate & Download</span>
                    <div id="btn-spinner" class="spinner border-2 border-white rounded-full ml-3 hidden"></div>
                </button>
            </div>
        </div>

        <!-- Status & Information Section -->
        <div id="status-area" class="space-y-3 text-sm text-gray-600 dark:text-gray-400 hidden">
            <h3 class="text-lg font-semibold border-b border-gray-200 dark:border-gray-700 pb-2">Processing Information</h3>
            <div id="info-original-pages" class="flex justify-between"></div>
            <div id="info-signature-size" class="flex justify-between"></div>
            <div id="info-num-signatures" class="flex justify-between"></div>
            <div id="info-flyleaf-status" class="flex justify-between"></div>
            <div id="info-padded-pages" class="flex justify-between"></div>
            <div id="status-message" class="pt-2 font-medium text-green-600 dark:text-green-400"></div>
            <div id="error-message" class="pt-2 font-medium text-red-600 dark:text-red-400"></div>
        </div>

    </main>

    <script>
        // --- DOM Element References ---
        const pdfUploadInput = document.getElementById('pdf-upload');
        const fileNameDisplay = document.getElementById('file-name-display');
        const signatureSizeSelect = document.getElementById('signature-size');
        const processBtn = document.getElementById('process-btn');
        const btnText = document.getElementById('btn-text');
        const btnSpinner = document.getElementById('btn-spinner');
        const statusArea = document.getElementById('status-area');
        const infoOriginalPages = document.getElementById('info-original-pages');
        const infoSignatureSize = document.getElementById('info-signature-size');
        const infoNumSignatures = document.getElementById('info-num-signatures');
        const infoPaddedPages = document.getElementById('info-padded-pages');
        const statusMessage = document.getElementById('status-message');
        const errorMessage = document.getElementById('error-message');
        const separateCoverFlyleafCheckbox = document.getElementById('separate-cover-flyleaf');

        // --- PDF Library ---
        const { PDFDocument } = PDFLib;
        let uploadedFile = null;
        let currentOriginalPageCount = 0; 

        // --- Event Listeners ---
        pdfUploadInput.addEventListener('change', handleFileSelect);
        processBtn.addEventListener('click', processPDF);
        separateCoverFlyleafCheckbox.addEventListener('change', () => {
            if (currentOriginalPageCount > 0) {
                updateSignatureOptions(currentOriginalPageCount);
            }
        });

        /**
         * Updates the signature dropdown with dynamic info and auto-selects the best option.
         */
        function updateSignatureOptions(originalPageCount) {
            const separateCoverCheckbox = document.getElementById('separate-cover-flyleaf');
            let adjustedPageCount = originalPageCount;

            if (separateCoverCheckbox.checked && originalPageCount >= 2) {
                adjustedPageCount += 2; 
            }

            let minBlanks = Infinity;
            let bestSignatureSize = null;

            const options = signatureSizeSelect.getElementsByTagName('option');

            for (const option of options) {
                const sigSize = parseInt(option.value, 10);
                if (isNaN(sigSize)) continue;

                const numSheets = sigSize / 4;
                const numSignatures = Math.ceil(adjustedPageCount / sigSize);
                const totalPages = numSignatures * sigSize;
                const blanksAdded = totalPages - adjustedPageCount;
                
                option.textContent = `${sigSize} pages (${numSheets} sheets) â€” ${numSignatures} sigs, adds ${blanksAdded} blank(s)`;

                if (sigSize >= 16 && sigSize <= 32) {
                    if (blanksAdded < minBlanks) {
                        minBlanks = blanksAdded;
                        bestSignatureSize = sigSize;
                    }
                }
            }

            if (bestSignatureSize !== null) {
                signatureSizeSelect.value = bestSignatureSize;
            }
        }

        /**
         * Handles the file input change event.
         */
        async function handleFileSelect(event) {
            const files = event.target.files;
            currentOriginalPageCount = 0; 

            if (files.length === 0) {
                fileNameDisplay.textContent = 'Click to browse or drag & drop';
                fileNameDisplay.classList.remove('text-indigo-700', 'dark:text-indigo-300', 'font-semibold', 'text-red-600', 'dark:text-red-400');
                fileNameDisplay.classList.add('text-gray-500', 'dark:text-gray-400');
                resetStatus();
                uploadedFile = null;
                processBtn.disabled = true;
                return;
            }

            uploadedFile = files[0];
            fileNameDisplay.textContent = 'Analyzing PDF...';
            fileNameDisplay.classList.remove('text-gray-500', 'dark:text-gray-400');
            fileNameDisplay.classList.add('text-indigo-700', 'dark:text-indigo-300', 'font-semibold');
            resetStatus();
            
            try {
                const existingPdfBytes = await uploadedFile.arrayBuffer();
                const pdfDoc = await PDFDocument.load(existingPdfBytes);
                const originalPageCount = pdfDoc.getPageCount();
                currentOriginalPageCount = originalPageCount; 

                updateSignatureOptions(originalPageCount);

                fileNameDisplay.textContent = uploadedFile.name; 

            } catch (err) {
                console.error("Failed to analyze PDF:", err);
                fileNameDisplay.textContent = "Could not read PDF";
                fileNameDisplay.classList.remove('text-indigo-700', 'dark:text-indigo-300');
                fileNameDisplay.classList.add('text-red-600', 'dark:text-red-400');
                errorMessage.textContent = 'Invalid or corrupt PDF file.';
                statusArea.classList.remove('hidden');
                uploadedFile = null; 
                currentOriginalPageCount = 0; 
            }
        }

        function resetStatus() {
            statusArea.classList.add('hidden');
            statusMessage.textContent = '';
            errorMessage.textContent = '';
        }

        function setProcessingState(isProcessing) {
            processBtn.disabled = isProcessing;
            if (isProcessing) {
                btnText.classList.add('hidden');
                btnSpinner.classList.remove('hidden');
            } else {
                btnText.classList.remove('hidden');
                btnSpinner.classList.add('hidden');
            }
        }

        function updateInfoPanel(originalPages, sigSize, numSigs, finalPages, flyleafsAdded) {
            infoOriginalPages.innerHTML = `<span>Original Page Count:</span> <strong>${originalPages}</strong>`;
            infoSignatureSize.innerHTML = `<span>Pages per Signature:</span> <strong>${sigSize}</strong>`;
            infoNumSignatures.innerHTML = `<span>Number of Signatures:</span> <strong>${numSigs}</strong>`;

            const infoFlyleafStatusDiv = document.getElementById('info-flyleaf-status');
            if (flyleafsAdded) {
                infoFlyleafStatusDiv.innerHTML = `<span>Flyleaves:</span> <strong>Active (2 pages added)</strong>`;
            } else {
                infoFlyleafStatusDiv.innerHTML = `<span>Flyleaves:</span> <strong>Inactive</strong>`;
            }

            infoPaddedPages.innerHTML = `<span>Final Page Count (incl. padding & flyleaves):</span> <strong>${finalPages}</strong>`;
            statusArea.classList.remove('hidden');
        }


        /**
         * The core function to repaginate the PDF.
         */
        async function processPDF() {
            // 1. Validate inputs
            if (!uploadedFile) {
                errorMessage.textContent = 'Please upload a PDF file first.';
                statusArea.classList.remove('hidden');
                return;
            }
            const signatureSize = parseInt(signatureSizeSelect.value, 10);
            if (signatureSize % 4 !== 0) {
                errorMessage.textContent = 'Signature size must be a multiple of 4.';
                statusArea.classList.remove('hidden');
                return;
            }

            resetStatus();
            setProcessingState(true);
            statusMessage.textContent = 'Reading PDF file...';
            statusArea.classList.remove('hidden');

            try {
                // 2. Load the PDF
                const existingPdfBytes = await uploadedFile.arrayBuffer();
                const pdfDoc = await PDFDocument.load(existingPdfBytes);
                const originalPageCount = pdfDoc.getPageCount();
                const isFlyleafEnabled = document.getElementById('separate-cover-flyleaf').checked;

                let processingPageCount = originalPageCount;
                if (isFlyleafEnabled && originalPageCount >= 2) {
                    processingPageCount += 2; // For front and back flyleaves
                }

                // 3. Calculate padding and signature layout
                const totalPages = Math.ceil(processingPageCount / signatureSize) * signatureSize;
                const numSignatures = totalPages / signatureSize;
                
                const flyleafsEffectivelyAdded = isFlyleafEnabled && originalPageCount >= 2;
                updateInfoPanel(originalPageCount, signatureSize, numSignatures, totalPages, flyleafsEffectivelyAdded);
                statusMessage.textContent = 'Preparing pages for imposition...';

                const newPdfDoc = await PDFDocument.create();
                const font = await newPdfDoc.embedFont(PDFLib.StandardFonts.Helvetica);
                const copiedOriginalPages = await newPdfDoc.copyPages(pdfDoc, pdfDoc.getPageIndices());
                
                let pagesForImposition = [];
                const BLANK_PAGE_MARKER = { isBlank: true };

                if (isFlyleafEnabled && originalPageCount >= 2) {
                    pagesForImposition.push(copiedOriginalPages[0]); // Front Cover
                    pagesForImposition.push(BLANK_PAGE_MARKER);      // Flyleaf
                    for (let i = 1; i < originalPageCount - 1; i++) {
                        pagesForImposition.push(copiedOriginalPages[i]);
                    }
                    pagesForImposition.push(BLANK_PAGE_MARKER);      // Flyleaf
                    pagesForImposition.push(copiedOriginalPages[originalPageCount - 1]); // Back Cover
                } else {
                    pagesForImposition = [...copiedOriginalPages];
                }

                statusMessage.textContent = 'Calculating new page order...';
                
                // 4. Generate the new page order.
                // Process signatures sequentially. Within each signature, reorder pages
                // to form printer spreads (imposition).
                // Use shared logic from src/imposition_logic.js
                const imposedOrderIndices = ImpositionLogic.generateImpositionMap(processingPageCount, signatureSize);

                statusMessage.textContent = 'Assembling new PDF document...';
                
                // 5. Add pages to the new document in the calculated order
                let pageDimensionSource = copiedOriginalPages.length > 0 ? copiedOriginalPages[0] : (pdfDoc.getPages().length > 0 ? pdfDoc.getPage(0) : null);
                if (!pageDimensionSource && originalPageCount > 0) pageDimensionSource = pdfDoc.getPage(0);
                const defaultPageSize = pageDimensionSource ? pageDimensionSource.getSize() : { width: 612, height: 792 };

                for (const sourcePageIndex of imposedOrderIndices) {
                    if (sourcePageIndex < processingPageCount) {
                        const pageItem = pagesForImposition[sourcePageIndex];
                        if (pageItem && pageItem.isBlank) {
                            const page = newPdfDoc.addPage([defaultPageSize.width, defaultPageSize.height]);
                            // Draw invisible text to ensure page has content
                            page.drawText(' ', { font, size: 1, x: 0, y: 0, opacity: 0 });
                        } else if (pageItem) { 
                            newPdfDoc.addPage(pageItem);
                        } else {
                            // Fallback for unexpected error
                            newPdfDoc.addPage([defaultPageSize.width, defaultPageSize.height]);
                        }
                    } else { 
                        // Padding page
                        const page = newPdfDoc.addPage([defaultPageSize.width, defaultPageSize.height]);
                        // Draw invisible text to ensure page has content
                        page.drawText(' ', { font, size: 1, x: 0, y: 0, opacity: 0 });
                    }
                }

                // 6. Save the PDF and trigger download
                statusMessage.textContent = 'Finalizing PDF... Preparing download.';
                let newPdfBytes = await newPdfDoc.save();

                // Check for 2-up request
                const is2UpEnabled = document.getElementById('create-2up').checked;
                if (is2UpEnabled) {
                    statusMessage.textContent = 'Creating 2-up spreads...';
                    // Use shared logic from src/layout_logic.js
                    newPdfBytes = await LayoutLogic.create2UpSpreads(newPdfBytes);
                }

                const blob = new Blob([newPdfBytes], { type: 'application/pdf' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `imposed_${uploadedFile.name}`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                statusMessage.textContent = 'Success! Your repaginated PDF has been downloaded.';

            } catch (err) {
                console.error(err);
                errorMessage.textContent = `An error occurred: ${err.message}`;
            } finally {
                setProcessingState(false);
            }
        }
    </script>
</body>
</html>
