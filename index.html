<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Booklet Signature Imposer</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- pdf-lib: A library for creating and modifying PDF documents -->
    <script src="https://cdn.jsdelivr.net/npm/pdf-lib/dist/pdf-lib.min.js"></script>
    <style>
        /* Custom styles for a better look and feel */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .file-input-label {
            transition: background-color 0.2s, border-color 0.2s;
        }
        #process-btn {
            transition: background-color 0.2s, transform 0.2s;
        }
        #process-btn:hover {
            transform: translateY(-2px);
        }
        #process-btn:disabled {
            cursor: not-allowed;
            opacity: 0.5;
            transform: none;
        }
        .spinner {
            border-top-color: transparent;
            width: 1rem;
            height: 1rem;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200 min-h-screen flex items-center justify-center p-4">

    <main class="w-full max-w-2xl bg-white dark:bg-gray-800 rounded-2xl shadow-2xl p-6 md:p-10 space-y-8">
        <!-- Header Section -->
        <header class="text-center">
            <h1 class="text-3xl md:text-4xl font-bold text-indigo-600 dark:text-indigo-400">PDF Signature Imposer</h1>
            <p class="mt-2 text-gray-600 dark:text-gray-400">Reorder PDF pages for multi-signature booklet printing.</p>
        </header>

        <!-- Main Controls Section -->
        <div class="space-y-6">
            <!-- Step 1: Upload PDF -->
            <div>
                <label for="pdf-upload" class="block text-lg font-semibold mb-2">1. Upload PDF</label>
                <label for="pdf-upload" class="file-input-label flex items-center justify-center w-full h-32 px-4 text-center bg-gray-50 dark:bg-gray-700 border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-600">
                    <span id="file-name-display" class="text-gray-500 dark:text-gray-400">Click to browse or drag & drop</span>
                </label>
                <input type="file" id="pdf-upload" class="hidden" accept=".pdf">
            </div>

            <!-- Step 2: Signature Size -->
            <div>
                <label for="signature-size" class="block text-lg font-semibold mb-2">2. Pages per Signature</label>
                <select id="signature-size" class="w-full p-3 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                    <option value="4">4 pages (1 sheet)</option>
                    <option value="8">8 pages (2 sheets)</option>
                    <option value="12">12 pages (3 sheets)</option>
                    <option value="16" selected>16 pages (4 sheets)</option>
                    <option value="20">20 pages (5 sheets)</option>
                    <option value="24">24 pages (6 sheets)</option>
                    <option value="28">28 pages (7 sheets)</option>
                    <option value="32">32 pages (8 sheets)</option>
                </select>
                <p class="text-xs text-gray-500 mt-1">Must be a multiple of 4. Efficiency is auto-selected for 16-32 pages.</p>
            </div>

            <!-- Action Button -->
            <div class="pt-4">
                <button id="process-btn" class="w-full flex items-center justify-center bg-indigo-600 text-white font-bold text-lg py-4 rounded-lg shadow-lg hover:bg-indigo-700 disabled:bg-indigo-400">
                    <span id="btn-text">Repaginate & Download</span>
                    <div id="btn-spinner" class="spinner border-2 border-white rounded-full ml-3 hidden"></div>
                </button>
            </div>
        </div>

        <!-- Status & Information Section -->
        <div id="status-area" class="space-y-3 text-sm text-gray-600 dark:text-gray-400 hidden">
            <h3 class="text-lg font-semibold border-b border-gray-200 dark:border-gray-700 pb-2">Processing Information</h3>
            <div id="info-original-pages" class="flex justify-between"></div>
            <div id="info-signature-size" class="flex justify-between"></div>
            <div id="info-num-signatures" class="flex justify-between"></div>
            <div id="info-padded-pages" class="flex justify-between"></div>
            <div id="status-message" class="pt-2 font-medium text-green-600 dark:text-green-400"></div>
            <div id="error-message" class="pt-2 font-medium text-red-600 dark:text-red-400"></div>
        </div>

    </main>

    <script>
        // --- DOM Element References ---
        const pdfUploadInput = document.getElementById('pdf-upload');
        const fileNameDisplay = document.getElementById('file-name-display');
        const signatureSizeSelect = document.getElementById('signature-size');
        const processBtn = document.getElementById('process-btn');
        const btnText = document.getElementById('btn-text');
        const btnSpinner = document.getElementById('btn-spinner');
        const statusArea = document.getElementById('status-area');
        const infoOriginalPages = document.getElementById('info-original-pages');
        const infoSignatureSize = document.getElementById('info-signature-size');
        const infoNumSignatures = document.getElementById('info-num-signatures');
        const infoPaddedPages = document.getElementById('info-padded-pages');
        const statusMessage = document.getElementById('status-message');
        const errorMessage = document.getElementById('error-message');

        // --- PDF Library ---
        const { PDFDocument } = PDFLib;
        let uploadedFile = null;

        // --- Event Listeners ---
        pdfUploadInput.addEventListener('change', handleFileSelect);
        processBtn.addEventListener('click', processPDF);

        /**
         * Updates the signature dropdown with dynamic info and auto-selects the best option.
         * @param {number} originalPageCount - The number of pages in the uploaded PDF.
         */
        function updateSignatureOptions(originalPageCount) {
            let minBlanks = Infinity;
            let bestSignatureSize = null;

            const options = signatureSizeSelect.getElementsByTagName('option');

            for (const option of options) {
                const sigSize = parseInt(option.value, 10);
                if (isNaN(sigSize)) continue;

                const numSheets = sigSize / 4;
                const numSignatures = Math.ceil(originalPageCount / sigSize);
                const totalPages = numSignatures * sigSize;
                const blanksAdded = totalPages - originalPageCount;
                
                // Update the label text
                option.textContent = `${sigSize} pages (${numSheets} sheets) â€” ${numSignatures} sigs, adds ${blanksAdded} blank(s)`;

                // Check for the most efficient option within the preferred range (16-32 pages)
                if (sigSize >= 16 && sigSize <= 32) {
                    if (blanksAdded < minBlanks) {
                        minBlanks = blanksAdded;
                        bestSignatureSize = sigSize;
                    }
                    // Tie-breaking rule: if blanks are equal, the smaller size is preferred.
                    // This is handled automatically because the loop processes smaller sizes first.
                }
            }

            // Auto-select the best option found
            if (bestSignatureSize !== null) {
                signatureSizeSelect.value = bestSignatureSize;
            }
        }

        /**
         * Handles the file input change event, reads the PDF to get page count,
         * and triggers the UI updates.
         */
        async function handleFileSelect(event) {
            const files = event.target.files;
            if (files.length === 0) return;

            uploadedFile = files[0];
            fileNameDisplay.textContent = 'Analyzing PDF...';
            fileNameDisplay.classList.remove('text-gray-500', 'dark:text-gray-400');
            fileNameDisplay.classList.add('text-indigo-700', 'dark:text-indigo-300', 'font-semibold');
            resetStatus();
            
            try {
                const existingPdfBytes = await uploadedFile.arrayBuffer();
                const pdfDoc = await PDFDocument.load(existingPdfBytes);
                const originalPageCount = pdfDoc.getPageCount();

                updateSignatureOptions(originalPageCount);

                fileNameDisplay.textContent = uploadedFile.name; // Show final filename

            } catch (err) {
                console.error("Failed to analyze PDF:", err);
                fileNameDisplay.textContent = "Could not read PDF";
                fileNameDisplay.classList.remove('text-indigo-700', 'dark:text-indigo-300');
                fileNameDisplay.classList.add('text-red-600', 'dark:text-red-400');
                errorMessage.textContent = 'Invalid or corrupt PDF file.';
                statusArea.classList.remove('hidden');
                uploadedFile = null; // Clear the invalid file
            }
        }

        /**
         * Resets the status and error messages in the UI.
         */
        function resetStatus() {
            statusArea.classList.add('hidden');
            statusMessage.textContent = '';
            errorMessage.textContent = '';
        }

        /**
         * Sets the UI to a processing state.
         * @param {boolean} isProcessing - Whether the app is currently processing.
         */
        function setProcessingState(isProcessing) {
            processBtn.disabled = isProcessing;
            if (isProcessing) {
                btnText.classList.add('hidden');
                btnSpinner.classList.remove('hidden');
            } else {
                btnText.classList.remove('hidden');
                btnSpinner.classList.add('hidden');
            }
        }

        /**
         * Updates the information display panel with processing details.
         */
        function updateInfoPanel(originalPages, sigSize, numSigs, finalPages) {
            infoOriginalPages.innerHTML = `<span>Original Page Count:</span> <strong>${originalPages}</strong>`;
            infoSignatureSize.innerHTML = `<span>Pages per Signature:</span> <strong>${sigSize}</strong>`;
            infoNumSignatures.innerHTML = `<span>Number of Signatures:</span> <strong>${numSigs}</strong>`;
            infoPaddedPages.innerHTML = `<span>Final Page Count (with padding):</span> <strong>${finalPages}</strong>`;
            statusArea.classList.remove('hidden');
        }


        /**
         * The core function to repaginate the PDF.
         * It reads the file, calculates the new page order, creates a new PDF,
         * and triggers the download.
         */
        async function processPDF() {
            // 1. Validate inputs
            if (!uploadedFile) {
                errorMessage.textContent = 'Please upload a PDF file first.';
                statusArea.classList.remove('hidden');
                return;
            }
            const signatureSize = parseInt(signatureSizeSelect.value, 10);
            if (signatureSize % 4 !== 0) {
                errorMessage.textContent = 'Signature size must be a multiple of 4.';
                statusArea.classList.remove('hidden');
                return;
            }

            resetStatus();
            setProcessingState(true);
            statusMessage.textContent = 'Reading PDF file...';
            statusArea.classList.remove('hidden');

            try {
                // 2. Load the PDF
                const existingPdfBytes = await uploadedFile.arrayBuffer();
                const pdfDoc = await PDFDocument.load(existingPdfBytes);
                const originalPageCount = pdfDoc.getPageCount();

                // 3. Calculate padding and signature layout
                const totalPages = Math.ceil(originalPageCount / signatureSize) * signatureSize;
                const numSignatures = totalPages / signatureSize;
                const pagesToPad = totalPages - originalPageCount;
                
                updateInfoPanel(originalPageCount, signatureSize, numSignatures, totalPages);
                statusMessage.textContent = 'Calculating new page order...';
                
                // 4. Generate the new page order
                const newPageOrder = new Array(totalPages);
                const pagesPerSignatureHalf = signatureSize / 2;

                for (let sigIndex = 0; sigIndex < numSignatures; sigIndex++) {
                    const sigStartPage = sigIndex * signatureSize;
                    for (let i = 0; i < pagesPerSignatureHalf; i++) {
                        const originalFrontPage = sigStartPage + i;
                        const originalBackPage = sigStartPage + signatureSize - 1 - i;
                        
                        const newDocFrontSlot = (sigIndex * pagesPerSignatureHalf) + i;
                        const newDocBackSlot = totalPages - 1 - newDocFrontSlot;

                        newPageOrder[newDocFrontSlot] = originalFrontPage;
                        newPageOrder[newDocBackSlot] = originalBackPage;
                    }
                }

                // 5. Create the new PDF document
                statusMessage.textContent = 'Assembling new PDF document...';
                const newPdfDoc = await PDFDocument.create();
                
                const copiedPages = await newPdfDoc.copyPages(pdfDoc, pdfDoc.getPageIndices());

                // 6. Add pages to the new document in the calculated order
                for (const pageIndex of newPageOrder) {
                    if (pageIndex < originalPageCount) {
                        newPdfDoc.addPage(copiedPages[pageIndex]);
                    } else {
                        const { width, height } = copiedPages[0].getSize();
                        newPdfDoc.addPage([width, height]);
                    }
                }

                // 7. Save the PDF and trigger download
                statusMessage.textContent = 'Finalizing PDF... Preparing download.';
                const newPdfBytes = await newPdfDoc.save();
                const blob = new Blob([newPdfBytes], { type: 'application/pdf' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `imposed_${uploadedFile.name}`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                statusMessage.textContent = 'Success! Your repaginated PDF has been downloaded.';

            } catch (err) {
                console.error(err);
                errorMessage.textContent = `An error occurred: ${err.message}`;
            } finally {
                setProcessingState(false);
            }
        }
    </script>
</body>
</html>
